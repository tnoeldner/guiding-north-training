# Assign Scenarios Feature Documentation

## Overview
The "Assign Scenarios" feature allows supervisors to create and assign targeted training scenarios to their direct reports based on specific topics. Staff members can then view, respond to, and complete these assigned scenarios.

## Changes Made

### 1. Supervisor Tab Structure (Updated)
**File**: `app.py` (lines 550-567)

Supervisors now have **7 tabs** instead of 6:
1. Scenario Simulator
2. Tone Polisher
3. **Assign Scenarios** (NEW)
4. Pending Review
5. Guiding NORTH Framework
6. Org Chart
7. Results & Progress

### 2. Staff Tab Structure (Updated)
**File**: `app.py` (lines 568-583)

Staff now have **6 tabs** instead of 5:
1. Scenario Simulator
2. Tone Polisher
3. **Assigned Scenarios** (NEW)
4. Guiding NORTH Framework
5. Org Chart
6. Results & Progress

### 3. Assign Scenarios Tab Implementation
**File**: `app.py` (lines 1210-1318)

#### Supervisor Features:
- **Staff Selection**: Multi-select dropdown to choose which direct reports receive the scenario
- **Topic Selection**: Pre-defined list of 12 training topics:
  - Roommate Conflict
  - Noise Complaint
  - Housing Policy Question
  - Maintenance Request
  - Room Change Request
  - Lease Violation
  - Guest Policy Issue
  - Parking Problem
  - Meeting Room Reservation
  - Billing Question
  - Community Standards
  - Student Wellness Concern

- **Scenario Generation**: Uses Gemini API to generate realistic housing/residence life scenarios
  - Prompts AI to create scenarios that require application of Guiding North Framework
  - Includes context (building, time, students involved)
  - Formatted with: Title, Situation, Context, Task

- **Assignment Storage**: Saves to `scenario_assignments.json` with metadata:
  - Unique assignment ID
  - Supervisor email and name
  - Staff email and name
  - Topic
  - Generated scenario text
  - Assigned date
  - Completion status
  - Response (when completed)
  - Response date

#### Data Structure:
```json
{
  "assignments": [
    {
      "id": "1234567890_staff@example.com",
      "supervisor_email": "supervisor@example.com",
      "supervisor_name": "John Doe",
      "staff_email": "staff@example.com",
      "staff_name": "Jane Smith",
      "topic": "Roommate Conflict",
      "scenario": "Generated scenario text...",
      "assigned_date": "2024-01-15T10:30:00",
      "completed": false,
      "response": null,
      "response_date": null
    }
  ]
}
```

### 4. Assigned Scenarios Tab Implementation
**File**: `app.py` (lines 1400-1484)

#### Staff Features:
- **View Assigned Scenarios**: See all scenarios assigned to them
- **Filter by Status**: Two sub-tabs
  - **Pending**: Not yet completed scenarios
  - **Completed**: Finished scenarios with supervisor feedback

- **Respond to Scenarios**: Text area to enter response describing how they would handle the situation

- **Submit Response**: 
  - Saves response to assignment record
  - Marks as completed
  - Shows confirmation message

- **Delete Assignment**: Remove a scenario from their list

- **View Supervisor Feedback**: See feedback on completed scenarios (if provided)

## Data Persistence

### New File: `scenario_assignments.json`
- Stores all scenario assignments and responses
- Loaded by `load_assignments()` function
- Saved by `save_assignments(data)` function
- Both functions use UTF-8 encoding for consistency

### Existing Function Updates
- `load_assignments()` - Returns `{"assignments": []}` structure
- `save_assignments(data)` - Persists data with error handling

## Workflow

### Supervisor's Perspective:
1. Login as supervisor
2. Click "Assign Scenarios" tab
3. Select staff members from direct reports
4. Choose a topic
5. Click "Generate and Assign Scenario"
6. Scenario is generated by Gemini API
7. Assignment saved to `scenario_assignments.json`
8. Staff receive notification (in their Assigned Scenarios tab)

### Staff's Perspective:
1. Login as staff member
2. Click "Assigned Scenarios" tab
3. See scenarios in "Pending" tab
4. Read scenario and context
5. Enter response in text area
6. Click "Submit Response"
7. Response saved and scenario moves to "Completed" tab
8. Can view supervisor feedback when provided

## API Integration

- **Gemini API Client**: Initialized from sidebar with API key
- **Model Selection**: Uses staff's selected model or defaults to `gemini-1.5-flash`
- **Topic-Specific Prompts**: Generated scenarios are tailored to selected topic
- **Error Handling**: Displays user-friendly error messages if API fails

## Security & Access Control

- **Supervisors**: Can only assign to their direct reports (based on org_chart)
- **Staff**: Can only see assignments sent to their email address
- **Role-Based**: Staff can only view their own assigned scenarios

## Technical Details

### Imports Required
- `datetime` (already present)
- `google.genai` (already present)
- `json` (already present)
- `streamlit` (already present)

### Constants Used
- `ASSIGNMENTS_FILE = "scenario_assignments.json"`
- Topic list defined in the tab

### Functions Called
- `load_assignments()` - Load existing assignments
- `save_assignments()` - Save new/updated assignments
- `load_users()` - Get staff member details
- `genai.Client()` - Initialize Gemini API client
- `client.models.generate_content()` - Generate scenarios

## Future Enhancement Opportunities

1. **Supervisor Feedback**: Add ability for supervisors to review and comment on staff responses
2. **Bulk Assignments**: Allow assigning same scenario to multiple staff at once
3. **Scenario Library**: Save generated scenarios for reuse
4. **Custom Topics**: Allow supervisors to define custom scenario topics
5. **Assignment Analytics**: Track completion rates and response times
6. **Email Notifications**: Notify staff when scenarios are assigned
7. **Scenario Difficulty**: Add difficulty level to supervisor-assigned scenarios
8. **Group Training**: Support assigning scenarios to role groups (all RAs, all RDs, etc.)

## Testing Checklist

- [ ] Supervisor can select multiple staff members
- [ ] Topic selection works with all 12 topics
- [ ] Scenario generation succeeds without API errors
- [ ] Assignment saves to scenario_assignments.json
- [ ] Staff can see assigned scenarios in their tab
- [ ] Staff can submit responses
- [ ] Responses save correctly
- [ ] Completed scenarios show in "Completed" tab
- [ ] Supervisors can see their pending review scenarios
- [ ] Delete functionality removes assignments cleanly
